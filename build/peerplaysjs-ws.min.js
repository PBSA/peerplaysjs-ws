!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).peerplays_ws=t()}}(function(){return function s(r,c,a){function u(n,t){if(!c[n]){if(!r[n]){var e="function"==typeof require&&require;if(!t&&e)return e(n,!0);if(h)return h(n,!0);var i=new Error("Cannot find module '"+n+"'");throw i.code="MODULE_NOT_FOUND",i}var o=c[n]={exports:{}};r[n][0].call(o.exports,function(t){return u(r[n][1][t]||t)},o,o.exports,s,r,c,a)}return c[n].exports}for(var h="function"==typeof require&&require,t=0;t<a.length;t++)u(a[t]);return u}({1:[function(t,n,e){"use strict";e.__esModule=!0,e.ConnectionManager=e.ChainConfig=e.Apis=void 0;var i=r(t("./src/ApiInstances")),o=r(t("./src/ConnectionManager")),s=r(t("./src/ChainConfig"));function r(t){return t&&t.__esModule?t:{default:t}}e.Apis=i.default,e.ChainConfig=s.default,e.ConnectionManager=o.default},{"./src/ApiInstances":2,"./src/ChainConfig":3,"./src/ConnectionManager":5}],2:[function(t,n,e){"use strict";e.__esModule=!0;var i=r(t("./ChainWebSocket")),o=r(t("./GrapheneApi")),s=r(t("./ChainConfig"));function r(t){return t&&t.__esModule?t:{default:t}}var c=void 0,a=function(){function t(){!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t)}return t.prototype.connect=function(n,t){var e=this;if("undefined"!=typeof window&&window.location&&"https:"===window.location.protocol&&n.indexOf("wss://")<0)throw new Error("Secure domains require wss connection");this.ws_rpc=new i.default(n,this.statusCb,t),this.init_promise=this.ws_rpc.login("","").then(function(){console.log("Connected to API node:",n),e._db=new o.default(e.ws_rpc,"database"),e._net=new o.default(e.ws_rpc,"network_broadcast"),e._hist=new o.default(e.ws_rpc,"history"),e._crypto=new o.default(e.ws_rpc,"crypto"),e._bookie=new o.default(e.ws_rpc,"bookie");var t=e._db.init().then(function(){return e._db.exec("get_chain_id",[]).then(function(t){return e.chain_id=t,s.default.setChainId(t)})});return e.ws_rpc.on_reconnect=function(){e.ws_rpc.login("","").then(function(){e._db.init().then(function(){e.statusCb&&e.statusCb(i.default.status.RECONNECTED)}),e._net.init(),e._hist.init(),e._crypto.init(),e._bookie.init()})},Promise.all([t,e._net.init(),e._hist.init(),e._crypto.init().catch(function(t){return console.error("ApiInstance\tCrypto API Error",t)}),e._bookie.init()])})},t.prototype.close=function(){this.ws_rpc&&this.ws_rpc.close(),this.ws_rpc=null},t.prototype.db_api=function(){return this._db},t.prototype.network_api=function(){return this._net},t.prototype.history_api=function(){return this._hist},t.prototype.crypto_api=function(){return this._crypto},t.prototype.bookie_api=function(){return this._bookie},t.prototype.setRpcConnectionStatusCallback=function(t){this.statusCb=t},t}();e.default={setRpcConnectionStatusCallback:function(t){this.statusCb=t,c&&c.setRpcConnectionStatusCallback(t)},reset:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ws://localhost:8090",n=arguments[1],e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:4e3;return c&&(c.close(),c=null),(c=new a).setRpcConnectionStatusCallback(this.statusCb),c&&n&&c.connect(t,e),c},instance:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ws://localhost:8090",n=arguments[1],e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:4e3;return c||(c=new a).setRpcConnectionStatusCallback(this.statusCb),c&&n&&c.connect(t,e),c},chainId:function(){return this.instance().chain_id},close:function(){c&&(c.close(),c=null)}}},{"./ChainConfig":3,"./ChainWebSocket":4,"./GrapheneApi":6}],3:[function(t,n,e){"use strict";e.__esModule=!0;var i={core_asset:"PPY",address_prefix:"PPY",expire_in_secs:15,expire_in_secs_proposal:86400,review_in_secs_committee:86400},r={networks:{Peerplays:{core_asset:"PPY",address_prefix:"PPY",chain_id:"6b6b5f0ce7a36d323768e534f3edb41c6d6332a541a95725b98e28d140850134"},PeerplaysTestnet:{core_asset:"PPYTEST",address_prefix:"PPYTEST",chain_id:"be6b79295e728406cbb7494bcb626e62ad278fa4018699cf8f75739f4c1a81fd"}}},o=function(){function t(){!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,t),this.reset()}return t.prototype.reset=function(){Object.assign(this,i)},t.prototype.setChainId=function(t){for(var n=Object.keys(r),e=0,i=n.length;e<i;e++){var o=n[e],s=r[o];if(s.chain_id===t)return this.network_name=o,s.address_prefix&&(this.address_prefix=s.address_prefix),{network_name:o,network:s}}this.network_name||console.log("Unknown chain id (this may be a testnet)",t)},t.prototype.setPrefix=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"PPY";this.address_prefix=t},t}();e.default=new o},{}],4:[function(t,n,e){"use strict";e.__esModule=!0;var o=null;o="undefined"!=typeof WebSocket?WebSocket:t("ws");var s=["set_subscribe_callback","subscribe_to_market","broadcast_transaction_with_callback","set_pending_transaction_callback"],r=["unsubscribe_from_market","unsubscribe_from_accounts"],i=function(){function i(t,n){var e=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1e4;!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,i),this.statusCb=n,this.serverAddress=t,this.timeoutInterval=e,this.connected=!1,this.reconnectTimeout=null,this.on_reconnect=null,this.cbId=0,this.cbs={},this.subs={},this.unsub={},this.currentResolve=null,this.currentReject=null,this.healthCheck=null,this.status=i.status,this.onConnectionOpen=this.onConnectionOpen.bind(this),this.onConnectionClose=this.onConnectionClose.bind(this),this.onConnectionTerminate=this.onConnectionTerminate.bind(this),this.onConnectionError=this.onConnectionError.bind(this),this.onConnectionTimeout=this.onConnectionTimeout.bind(this),this.createConnection=this.createConnection.bind(this),this.createConnectionPromise=this.createConnectionPromise.bind(this),this.listener=this.listener.bind(this),this.createConnection()}return i.prototype.createConnection=function(){this.debug("!!! ChainWebSocket create connection"),this.reconnectTimeout=null,this.connect_promise||(this.connect_promise=new Promise(this.createConnectionPromise));try{this.ws=new o(this.serverAddress)}catch(t){return this.resetConnection()}this.addEventListeners(),this.connectionTimeout=setTimeout(this.onConnectionTimeout,this.timeoutInterval)},i.prototype.resetConnection=function(){this.close(),this.reconnectTimeout||(this.debug("!!! ChainWebSocket reset connection",this.timeoutInterval),this.reconnectTimeout=setTimeout(this.createConnection,this.timeoutInterval)),this.currentReject&&this.currentReject(new Error("Connection attempt failed: "+this.serverAddress))},i.prototype.addEventListeners=function(){this.debug("!!! ChainWebSocket add event listeners"),this.ws.addEventListener("open",this.onConnectionOpen),this.ws.addEventListener("close",this.onConnectionClose),this.ws.addEventListener("error",this.onConnectionError),this.ws.addEventListener("message",this.listener)},i.prototype.removeEventListeners=function(){this.debug("!!! ChainWebSocket remove event listeners"),this.ws.removeEventListener("open",this.onConnectionOpen),this.ws.removeEventListener("close",this.onConnectionClose),this.ws.removeEventListener("error",this.onConnectionError),this.ws.removeEventListener("message",this.listener)},i.prototype.createConnectionPromise=function(t,n){this.debug("!!! ChainWebSocket createPromise"),this.currentResolve=t,this.currentReject=n},i.prototype.onConnectionOpen=function(){this.debug("!!! ChainWebSocket Connected "),this.connected=!0,clearTimeout(this.connectionTimeout),this.connectionTimeout=null,this.on_reconnect&&this.on_reconnect(),this.currentResolve&&this.currentResolve(),this.statusCb&&this.statusCb(i.status.OPEN)},i.prototype.onConnectionTimeout=function(){this.debug("!!! ChainWebSocket timeout"),this.onConnectionClose(new Error("Connection timed out."))},i.prototype.onConnectionTerminate=function(){this.debug("!!! ChainWebSocket terminate"),this.onConnectionClose(new Error("Connection was terminated."))},i.prototype.onConnectionClose=function(t){this.debug("!!! ChainWebSocket Close ",t),this.resetConnection(),this.statusCb&&this.statusCb(i.status.CLOSED)},i.prototype.onConnectionError=function(t){this.debug("!!! ChainWebSocket On Connection Error ",t),this.resetConnection(),this.statusCb&&this.statusCb(i.status.ERROR)},i.prototype.call=function(t){var e=this;if(!this.connected)return this.debug("!!! ChainWebSocket Call not connected. "),Promise.reject(new Error("Disconnected from the BlockChain."));this.debug("!!! ChainWebSocket Call connected. ",t);var i={method:t[1],params:t,id:this.cbId+1};if(this.cbId=i.id,s.includes(i.method)&&(this.subs[i.id]={callback:i.params[2][0]},i.params[2][0]=i.id),r.includes(i.method)){if("function"!=typeof i.params[2][0])throw new Error("First parameter of unsub must be the original callback");var n=i.params[2].splice(0,1)[0];for(var o in this.subs)if(this.subs[o].callback===n){this.unsub[i.id]=o;break}}return this.healthCheck||(this.healthCheck=setTimeout(this.onConnectionTerminate.bind(this),1e4)),new Promise(function(t,n){e.cbs[i.id]={time:new Date,resolve:t,reject:n},i.method="call";try{e.ws.send(JSON.stringify(i))}catch(t){e.debug("Caught a nasty error : ",t)}})},i.prototype.listener=function(n){var e=null;try{e=JSON.parse(n.data)}catch(t){e.error="Error parsing response: "+t.stack,this.debug("Error parsing response: ",n)}this.healthCheck&&(clearTimeout(this.healthCheck),this.healthCheck=null);var t=!1,i=null;"notice"===e.method&&(t=!0,e.id=e.params[0]),(i=t?this.subs[e.id].callback:this.cbs[e.id])&&!t?(e.error?(this.debug("----\x3e responseJSON : ",e),i.reject(e.error)):i.resolve(e.result),delete this.cbs[e.id],this.unsub[e.id]&&(delete this.subs[this.unsub[e.id]],delete this.unsub[e.id])):i&&t?i(e.params[1]):this.debug("Warning: unknown websocket responseJSON: ",e)},i.prototype.login=function(t,n){var e=this;return this.debug("!!! ChainWebSocket login.",t,n),this.connect_promise.then(function(){return e.call([1,"login",[t,n]])})},i.prototype.close=function(){this.ws&&(this.removeEventListeners(),this.ws.close(),this.ws=null),clearTimeout(this.connectionTimeout),this.connectionTimeout=null,clearTimeout(this.healthCheck),this.healthCheck=null,clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null,this.connected=!1},i.prototype.debug=function(){},i}();i.status={RECONNECTED:"reconnected",OPEN:"open",CLOSED:"closed",ERROR:"error"},e.default=i},{ws:7}],5:[function(t,n,e){"use strict";e.__esModule=!0;var o=i(t("./ApiInstances")),s=i(t("./ChainWebSocket"));function i(t){return t&&t.__esModule?t:{default:t}}var r=function(){function i(t){var n=t.url,e=t.urls;!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,i),this.url=n,this.urls=e.filter(function(t){return t!==n})}return i.prototype.logFailure=function(t){console.error("Unable to connect to",t+", skipping to next full node API server")},i.prototype.isURL=function(t){return new RegExp("((^(?:ws(s)?:\\/\\/)|(?:http(s)?:\\/\\/))+((?:[^\\/\\/\\.])+\\??(?:[-\\+=&;%@.\\w_]*)((#?(?:[\\w])*)(:?[0-9]*))))").test(t)},i.prototype.connect=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.url;return new Promise(function(t,n){o.default.instance(i,e).init_promise.then(t).catch(function(t){o.default.instance().close(),n(t)})})},i.prototype.connectWithFallback=function(){var e=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.url,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,s=this,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,n=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;if(n&&o>this.urls.length-1)return n(new Error("Tried "+(o+1)+" connections, none of which worked: "+JSON.stringify(this.urls.concat(this.url))));var r=function(t,n){return s.logFailure(i),s.connectWithFallback(e,s.urls[o],o+1,t,n)};return t&&n?this.connect(e,i).then(t).catch(function(){r(t,n)}):new Promise(function(t,n){s.connect(e).then(t).catch(function(){r(t,n)})})},i.prototype.ping=function(o,t,n){var s={},r=o.serverAddress;if(!this.isURL(r))throw Error("URL NOT VALID",r);s[r]=(new Date).getTime();var e=function(i,n){o.login("","").then(function(t){var n;t&&o.close();var e=((n={})[r]=(new Date).getTime()-s[r],n);console.log("ping latency: ",e),i(e)}).catch(function(t){console.error("PING ERROR: ",t),n(t)})};if(!t||!n)return new Promise(e);e(t,n)},i.prototype.sortNodesByLatency=function(t,n){var i=this.checkConnections(),e=function(n,e){i.then(function(e){console.log("unsorted latency list: ",e);var t=Object.keys(e).sort(function(t,n){return e[t]-e[n]});n(t)}).catch(function(t){e(t)})};if(!t||!n)return new Promise(e);e(t,n)},i.prototype.checkConnections=function(t,n){var o=this,e=function(n,t){var e=o.urls,i=[];e.forEach(function(t){var n=new s.default(t,function(){});i.push(function(){return o.ping(n).then(function(t){return t}).catch(function(){return n.close(),null})})}),Promise.all(i.map(function(t){return t()})).then(function(t){n(t.filter(function(t){return!!t}).reduce(function(t,n){var e=Object.keys(n)[0];return t[e]=n[e],t},{}))}).catch(function(){return o.checkConnections(n,t)})};if(!t||!n)return new Promise(e);e(t,n)},i}();e.default=r},{"./ApiInstances":2,"./ChainWebSocket":4}],6:[function(t,n,e){"use strict";e.__esModule=!0;var i=function(){function e(t,n){!function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,e),this.ws_rpc=t,this.api_name=n}return e.prototype.init=function(){var n=this;return this.ws_rpc.call([1,this.api_name,[]]).then(function(t){return n.api_id=t,n})},e.prototype.exec=function(n,e){return this.ws_rpc.call([this.api_id,n,e]).catch(function(t){throw console.log("!!! GrapheneApi error: ",n,e,t,JSON.stringify(t)),t})},e}();e.default=i},{}],7:[function(t,n,e){},{}]},{},[1])(1)});