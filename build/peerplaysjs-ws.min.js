!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).peerplays_ws=t()}}(function(){return function s(r,c,a){function u(e,t){if(!c[e]){if(!r[e]){var n="function"==typeof require&&require;if(!t&&n)return n(e,!0);if(h)return h(e,!0);var i=new Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}var o=c[e]={exports:{}};r[e][0].call(o.exports,function(t){return u(r[e][1][t]||t)},o,o.exports,s,r,c,a)}return c[e].exports}for(var h="function"==typeof require&&require,t=0;t<a.length;t++)u(a[t]);return u}({1:[function(t,e,n){"use strict";n.__esModule=!0,n.Manager=n.ChainConfig=n.Apis=void 0;var i=r(t("./src/ApiInstances")),o=r(t("./src/ConnectionManager")),s=r(t("./src/ChainConfig"));function r(t){return t&&t.__esModule?t:{default:t}}n.Apis=i.default,n.ChainConfig=s.default,n.Manager=o.default},{"./src/ApiInstances":2,"./src/ChainConfig":3,"./src/ConnectionManager":5}],2:[function(t,e,n){"use strict";n.__esModule=!0;var i=r(t("./ChainWebSocket")),o=r(t("./GrapheneApi")),s=r(t("./ChainConfig"));function r(t){return t&&t.__esModule?t:{default:t}}var c=void 0,a=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}return t.prototype.connect=function(e,t){var n=this;if("undefined"!=typeof window&&window.location&&"https:"===window.location.protocol&&e.indexOf("wss://")<0)throw new Error("Secure domains require wss connection");this.ws_rpc=new i.default(e,this.statusCb,t),this.init_promise=this.ws_rpc.login("","").then(function(){console.log("Connected to API node:",e),n._db=new o.default(n.ws_rpc,"database"),n._net=new o.default(n.ws_rpc,"network_broadcast"),n._hist=new o.default(n.ws_rpc,"history"),n._crypto=new o.default(n.ws_rpc,"crypto"),n._bookie=new o.default(n.ws_rpc,"bookie");var t=n._db.init().then(function(){return n._db.exec("get_chain_id",[]).then(function(t){return n.chain_id=t,s.default.setChainId(t)})});return n.ws_rpc.on_reconnect=function(){n.ws_rpc.login("","").then(function(){n._db.init().then(function(){n.statusCb&&n.statusCb(i.default.status.RECONNECTED)}),n._net.init(),n._hist.init(),n._crypto.init(),n._bookie.init()})},Promise.all([t,n._net.init(),n._hist.init(),n._crypto.init().catch(function(t){return console.error("ApiInstance\tCrypto API Error",t)}),n._bookie.init()])})},t.prototype.close=function(){this.ws_rpc&&this.ws_rpc.close(),this.ws_rpc=null},t.prototype.db_api=function(){return this._db},t.prototype.network_api=function(){return this._net},t.prototype.history_api=function(){return this._hist},t.prototype.crypto_api=function(){return this._crypto},t.prototype.bookie_api=function(){return this._bookie},t.prototype.setRpcConnectionStatusCallback=function(t){this.statusCb=t},t}();n.default={setRpcConnectionStatusCallback:function(t){this.statusCb=t,c&&c.setRpcConnectionStatusCallback(t)},reset:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ws://localhost:8090",e=arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:4e3;return c&&(c.close(),c=null),(c=new a).setRpcConnectionStatusCallback(this.statusCb),c&&e&&c.connect(t,n),c},instance:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ws://localhost:8090",e=arguments[1],n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:4e3;return c||(c=new a).setRpcConnectionStatusCallback(this.statusCb),c&&e&&c.connect(t,n),c},chainId:function(){return this.instance().chain_id},close:function(){c&&(c.close(),c=null)}}},{"./ChainConfig":3,"./ChainWebSocket":4,"./GrapheneApi":6}],3:[function(t,e,n){"use strict";n.__esModule=!0;var i={core_asset:"PPY",address_prefix:"PPY",expire_in_secs:15,expire_in_secs_proposal:86400,review_in_secs_committee:86400},r={networks:{Peerplays:{core_asset:"PPY",address_prefix:"PPY",chain_id:"6b6b5f0ce7a36d323768e534f3edb41c6d6332a541a95725b98e28d140850134"},PeerplaysTestnet:{core_asset:"PPYTEST",address_prefix:"PPYTEST",chain_id:"be6b79295e728406cbb7494bcb626e62ad278fa4018699cf8f75739f4c1a81fd"}}},o=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.reset()}return t.prototype.reset=function(){Object.assign(this,i)},t.prototype.setChainId=function(t){for(var e=Object.keys(r),n=0,i=e.length;n<i;n++){var o=e[n],s=r[o];if(s.chain_id===t)return this.network_name=o,s.address_prefix&&(this.address_prefix=s.address_prefix),{network_name:o,network:s}}this.network_name||console.log("Unknown chain id (this may be a testnet)",t)},t.prototype.setPrefix=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"PPY";this.address_prefix=t},t}();n.default=new o},{}],4:[function(t,e,n){"use strict";n.__esModule=!0;var o=null;o="undefined"!=typeof WebSocket?WebSocket:t("ws");var s=["set_subscribe_callback","subscribe_to_market","broadcast_transaction_with_callback","set_pending_transaction_callback"],r=["unsubscribe_from_market","unsubscribe_from_accounts"],i=function(){function i(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:1e4;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,i),this.statusCb=e,this.serverAddress=t,this.timeoutInterval=n,this.connected=!1,this.reconnectTimeout=null,this.on_reconnect=null,this.cbId=0,this.cbs={},this.subs={},this.unsub={},this.currentResolve=null,this.currentReject=null,this.healthCheck=null,this.status=i.status,this.onConnectionOpen=this.onConnectionOpen.bind(this),this.onConnectionClose=this.onConnectionClose.bind(this),this.onConnectionTerminate=this.onConnectionTerminate.bind(this),this.onConnectionError=this.onConnectionError.bind(this),this.onConnectionTimeout=this.onConnectionTimeout.bind(this),this.createConnection=this.createConnection.bind(this),this.createConnectionPromise=this.createConnectionPromise.bind(this),this.listener=this.listener.bind(this),this.createConnection()}return i.prototype.createConnection=function(){this.debug("!!! ChainWebSocket create connection"),this.reconnectTimeout=null,this.connect_promise||(this.connect_promise=new Promise(this.createConnectionPromise));try{this.ws=new o(this.serverAddress)}catch(t){return this.resetConnection()}this.addEventListeners(),this.connectionTimeout=setTimeout(this.onConnectionTimeout,this.timeoutInterval)},i.prototype.resetConnection=function(){this.close(),this.reconnectTimeout||(this.debug("!!! ChainWebSocket reset connection",this.timeoutInterval),this.reconnectTimeout=setTimeout(this.createConnection,this.timeoutInterval)),this.currentReject&&this.currentReject(new Error("Connection attempt failed: "+this.serverAddress))},i.prototype.addEventListeners=function(){this.debug("!!! ChainWebSocket add event listeners"),this.ws.addEventListener("open",this.onConnectionOpen),this.ws.addEventListener("close",this.onConnectionClose),this.ws.addEventListener("error",this.onConnectionError),this.ws.addEventListener("message",this.listener)},i.prototype.removeEventListeners=function(){this.debug("!!! ChainWebSocket remove event listeners"),this.ws.removeEventListener("open",this.onConnectionOpen),this.ws.removeEventListener("close",this.onConnectionClose),this.ws.removeEventListener("error",this.onConnectionError),this.ws.removeEventListener("message",this.listener)},i.prototype.createConnectionPromise=function(t,e){this.debug("!!! ChainWebSocket createPromise"),this.currentResolve=t,this.currentReject=e},i.prototype.onConnectionOpen=function(){this.debug("!!! ChainWebSocket Connected "),this.connected=!0,clearTimeout(this.connectionTimeout),this.connectionTimeout=null,this.on_reconnect&&this.on_reconnect(),this.currentResolve&&this.currentResolve(),this.statusCb&&this.statusCb(i.status.OPEN)},i.prototype.onConnectionTimeout=function(){this.debug("!!! ChainWebSocket timeout"),this.onConnectionClose(new Error("Connection timed out."))},i.prototype.onConnectionTerminate=function(){this.debug("!!! ChainWebSocket terminate"),this.onConnectionClose(new Error("Connection was terminated."))},i.prototype.onConnectionClose=function(t){this.debug("!!! ChainWebSocket Close ",t),this.resetConnection(),this.statusCb&&this.statusCb(i.status.CLOSED)},i.prototype.onConnectionError=function(t){this.debug("!!! ChainWebSocket On Connection Error ",t),this.resetConnection(),this.statusCb&&this.statusCb(i.status.ERROR)},i.prototype.call=function(t){var n=this;if(!this.connected)return this.debug("!!! ChainWebSocket Call not connected. "),Promise.reject(new Error("Disconnected from the BlockChain."));this.debug("!!! ChainWebSocket Call connected. ",t);var i={method:t[1],params:t,id:this.cbId+1};if(this.cbId=i.id,s.includes(i.method)&&(this.subs[i.id]={callback:i.params[2][0]},i.params[2][0]=i.id),r.includes(i.method)){if("function"!=typeof i.params[2][0])throw new Error("First parameter of unsub must be the original callback");var e=i.params[2].splice(0,1)[0];for(var o in this.subs)if(this.subs[o].callback===e){this.unsub[i.id]=o;break}}return this.healthCheck||(this.healthCheck=setTimeout(this.onConnectionTerminate.bind(this),1e4)),new Promise(function(t,e){n.cbs[i.id]={time:new Date,resolve:t,reject:e},i.method="call";try{n.ws.send(JSON.stringify(i))}catch(t){n.debug("Caught a nasty error : ",t)}})},i.prototype.listener=function(e){var n=null;try{n=JSON.parse(e.data)}catch(t){n.error="Error parsing response: "+t.stack,this.debug("Error parsing response: ",e)}this.healthCheck&&(clearTimeout(this.healthCheck),this.healthCheck=null);var t=!1,i=null;"notice"===n.method&&(t=!0,n.id=n.params[0]),(i=t?this.subs[n.id].callback:this.cbs[n.id])&&!t?(n.error?(this.debug("----\x3e responseJSON : ",n),i.reject(n.error)):i.resolve(n.result),delete this.cbs[n.id],this.unsub[n.id]&&(delete this.subs[this.unsub[n.id]],delete this.unsub[n.id])):i&&t?i(n.params[1]):this.debug("Warning: unknown websocket responseJSON: ",n)},i.prototype.login=function(t,e){var n=this;return this.debug("!!! ChainWebSocket login.",t,e),this.connect_promise.then(function(){return n.call([1,"login",[t,e]])})},i.prototype.close=function(){this.ws&&(this.removeEventListeners(),this.ws.close(),this.ws=null),clearTimeout(this.connectionTimeout),this.connectionTimeout=null,clearTimeout(this.healthCheck),this.healthCheck=null,clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null,this.connected=!1},i.prototype.debug=function(){},i}();i.status={RECONNECTED:"reconnected",OPEN:"open",CLOSED:"closed",ERROR:"error"},n.default=i},{ws:7}],5:[function(t,e,n){"use strict";n.__esModule=!0;var o=i(t("./ApiInstances")),a=i(t("./ChainWebSocket"));function i(t){return t&&t.__esModule?t:{default:t}}var s=function(){function i(t){var e=t.url,n=t.urls;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,i),this.url=e,this.urls=n.filter(function(t){return t!==e})}return i.prototype.logFailure=function(t){console.error("Unable to connect to",t+", skipping to next full node API server")},i.prototype.connect=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.url;return new Promise(function(t,e){o.default.instance(i,n).init_promise.then(t).catch(function(t){o.default.instance().close(),e(t)})})},i.prototype.connectWithFallback=function(){var n=!(0<arguments.length&&void 0!==arguments[0])||arguments[0],i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.url,o=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0,s=this,t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null,e=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;if(e&&o>this.urls.length-1)return e(new Error("Tried "+(o+1)+" connections, none of which worked: "+JSON.stringify(this.urls.concat(this.url))));var r=function(t,e){return s.logFailure(i),s.connectWithFallback(n,s.urls[o],o+1,t,e)};return t&&e?this.connect(n,i).then(t).catch(function(){r(t,e)}):new Promise(function(t,e){s.connect(n).then(t).catch(function(){r(t,e)})})},i.prototype.sortNodesByLatency=function(t,e){var i=this.checkConnections(),n=function(e,n){i.then(function(n){console.log("unsorted latency list: ",n);var t=Object.keys(n).sort(function(t,e){return n[t]-n[e]});e(t)}).catch(function(t){n(t)})};if(!t||!e)return new Promise(n);n(t,e)},i.prototype.checkConnections=function(){var o=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",s=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"",r=this,t=arguments[2],e=arguments[3],c={},n=function(e,t){var n=r.urls.concat(r.url),i=[];n.forEach(function(e){var n=new a.default(e,function(){});c[e]=(new Date).getTime(),i.push(function(){return n.login(o,s).then(function(){var t;return n.close(),(t={})[e]=(new Date).getTime()-c[e],t}).catch(function(){return e===r.url?r.url=r.urls[0]:r.urls=r.urls.filter(function(t){return t!==e}),n.close(),null})})}),Promise.all(i.map(function(t){return t()})).then(function(t){e(t.filter(function(t){return!!t}).reduce(function(t,e){var n=Object.keys(e)[0];return t[n]=e[n],t},{}))}).catch(function(){return r.checkConnections(o,s,e,t)})};if(!t||!e)return new Promise(n);n(t,e)},i}();n.default=s},{"./ApiInstances":2,"./ChainWebSocket":4}],6:[function(t,e,n){"use strict";n.__esModule=!0;var i=function(){function n(t,e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),this.ws_rpc=t,this.api_name=e}return n.prototype.init=function(){var e=this;return this.ws_rpc.call([1,this.api_name,[]]).then(function(t){return e.api_id=t,e})},n.prototype.exec=function(e,n){return this.ws_rpc.call([this.api_id,e,n]).catch(function(t){throw console.log("!!! GrapheneApi error: ",e,n,t,JSON.stringify(t)),t})},n}();n.default=i},{}],7:[function(t,e,n){},{}]},{},[1])(1)});